## 变量实体 + Typeahead 菜单实现说明

本方案将“变量”实现为 Lexical 文本实体节点，并配合 Typeahead 风格的气泡菜单进行触发与插入，满足如下需求：

- 触发：在输入 `/` 或 `{` 时弹出菜单（不做搜索筛选，始终显示完整选项）。
- 选择：支持键盘上下、Enter、ESC，支持鼠标悬停高亮与点击确认；点击时不失焦。
- 插入：将选项以 `{{label}}` 的形式插入，且仅 `{{...}}` 片段是蓝色，前后普通文本不受影响。
- 编辑：Backspace 逐字删除，破坏 `}}` 后自动降级为普通文本（蓝色消失）。
- 粘贴/手动输入：`{{...}}` 会自动升格为实体（蓝色），非匹配则保持普通文本。
- 稳定性：加入 IME 组合输入保护与性能阈值；无障碍属性完善。

---

## 目录结构与核心文件

- 节点定义
  - `src/components/base/prompt-editor/nodes/VariableNode.ts`
    - 自定义文本实体节点，仅用于呈现 `{{...}}` 片段，DOM 上追加类名 `variable-node`。

- 实体转换插件（文本 ↔ 实体）
  - `src/components/base/prompt-editor/plugins/VariableEntityTransformPlugin.ts`
    - 将普通 `TextNode` 中符合规则的片段替换为 `VariableNode`；
    - 当 `VariableNode` 文本不再满足规则时，降级回普通 `TextNode`。

- Typeahead 菜单插件（触发与插入）
  - `src/components/base/prompt-editor/plugins/TypeaheadVariableMenuPlugin.tsx`
    - 监听编辑器更新，检测触发字符 `/` 或 `{`；
    - 在光标处渲染气泡菜单，提供键鼠交互与无障碍支持；
    - 选择后把触发字符与其后内容替换为 `VariableNode('{{label}}')`，并在其后插入普通文本节点承接后续输入。

- 样式（蓝色高亮）
  - `src/styles.css`
    - `.variable-node { color: #2563eb; }`

---

## 行为与细节

- 触发与菜单
  - 触发字符：`/`、`{`；
  - 不做查询筛选：菜单始终展示完整 `options`；
  - 无障碍：列表容器 `role=listbox`、`tabIndex=0`、`aria-activedescendant`，选项 `role=option` + `aria-selected` + 唯一 `id`；
  - 焦点：鼠标点击时 `onMouseDown(e.preventDefault())`，避免编辑器失焦；
  - IME 保护：组合输入期间不触发菜单，避免中文输入抖动。

- 插入逻辑（简述）
  - 找到最近的触发字符索引 `i`；
  - 将当前 `TextNode` 切分为三段：`before` + `VariableNode('{{label}}')` + `after`；
  - 将选区移到 `after` 的起始处，便于继续输入普通文本。

- 文本 ↔ 实体转换
  - 匹配规则（不含大括号与换行）：
    - 精确匹配：`^\{\{[^{}\n]+\}\}$`
    - 全局匹配：`/\{\{[^{}\n]+\}\}/g`
  - 普通文本 → 实体：当 `TextNode` 包含符合规则的片段时，用 `splitText` 分段，对完全匹配片段替换为 `VariableNode`；
  - 实体 → 普通文本：当 `VariableNode` 内容不再满足规则时，替换回 `TextNode`；
  - IME 保护：组合输入（`isComposing()`）时不做转换；
  - 性能阈值：单节点最大匹配计数（默认 300）超限则跳过，避免极端粘贴导致的过度分片。

- Backspace 行为
  - 逐字删除，`{{label}} → {{label}` 时降级为普通文本并失去蓝色；
  - 不使用 token 模式，保证字符级编辑体验。

---

## 接入与使用

在任意 Lexical 编辑器中：

```tsx
import { LexicalComposer } from '@lexical/react/LexicalComposer';
import { RichTextPlugin } from '@lexical/react/LexicalRichTextPlugin';
import { ContentEditable } from '@lexical/react/LexicalContentEditable';
import { LexicalErrorBoundary } from '@lexical/react/LexicalErrorBoundary';
import { HistoryPlugin } from '@lexical/react/LexicalHistoryPlugin';

import { VariableNode } from '@/components/base/prompt-editor/nodes/VariableNode';
import VariableEntityTransformPlugin from '@/components/base/prompt-editor/plugins/VariableEntityTransformPlugin';
import TypeaheadVariableMenuPlugin from '@/components/base/prompt-editor/plugins/TypeaheadVariableMenuPlugin';

const initialConfig = {
  namespace: 'YourEditor',
  onError: (e: Error) => console.error(e),
  nodes: [VariableNode],
};

export default function YourEditor() {
  return (
    <LexicalComposer initialConfig={initialConfig}>
      <RichTextPlugin contentEditable={<ContentEditable className="w-full h-full" />} ErrorBoundary={LexicalErrorBoundary} />
      <VariableEntityTransformPlugin />
      <TypeaheadVariableMenuPlugin options={["变量","日期","用户"]} />
      <HistoryPlugin />
    </LexicalComposer>
  );
}
```

样式：

```css
.variable-node {
  color: #2563eb;
}
```

---

## 扩展与定制建议

- 触发字符：如需自定义，可在 `TypeaheadVariableMenuPlugin` 中修改对 `charBefore` 的判断。
- 变量字符集：若要更严格或更宽松，调整正则中的字符类（例如允许空格、下划线、点等）。
- 性能阈值：根据业务文本长度调整单节点最大匹配计数。
- 菜单定位：可将 Portal 挂在编辑器根节点，并按根节点定位，适配自定义滚动容器。
- 无障碍：已添加基础属性，可进一步完善 active 样式或键盘环路（Home/End/PageUp/Down 等）。

---

## Extension 化思路（可选）

若要封装为独立扩展，建议提供统一初始化方法：

```ts
type CreateVariableExtensionOptions = {
  options?: string[];                // 菜单选项
  variableClass?: string;            // 变量样式类名，默认 'variable-node'
  triggers?: string[];               // 触发字符，默认 ['/', '{']
  maxMatchesPerNode?: number;        // 性能阈值，默认 300
  pattern?: RegExp;                  // 自定义精确匹配正则
};

function createVariableExtension(opts?: CreateVariableExtensionOptions) {
  // 返回 { nodes: [VariableNode], plugins: [<VariableEntityTransformPlugin .../>, <TypeaheadVariableMenuPlugin .../>] }
}
```

这样在编辑器初始化时即可统一注入节点与插件，降低接入复杂度。

---

## 已知边界与后续计划

- 规则匹配以正则为准：若变量语法变更，需同步更新正则与转换逻辑。
- 复杂富文本格式与变量叠加时的策略（加粗、下划线等）可按需求补充约束。
- 如需“整体删除”语义，可改为 token/DecoratorNode，或在删除前后进行拦截与替换。


